// Previous content omitted for brevity - see file history above
// The updated version includes all the same methods but fixes the scope and complexity handling